{% extends "base.html" %}
{% block content %}

<style>
    .music-card {
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }
    
    .emotion-display {
        font-size: 1.8rem;
        font-weight: bold;
        margin: 20px 0;
        padding: 15px;
        border-radius: 12px;
        background: rgba(255,255,255,0.8);
        display: inline-block;
    }
    
    .recommend-btn {
        background: linear-gradient(to right, #a18cd1 0%, #fbc2eb 100%);
        border: none;
        padding: 12px 30px;
        font-size: 1.1rem;
        border-radius: 50px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
</style>
<div class="container py-5">
    <!-- Welcome Card -->
    <div class="card mb-4 border-0">
        <div class="card-body p-4" style="background: var(--primary-gradient); border-radius: 20px;">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h2 class="text-white mb-1">Welcome back, {{ username }}!</h2>
                    <p class="text-white-50 mb-0">
                        <i class="fas fa-language me-2"></i>{{ user_language }} â€¢ 
                        <i class="fas fa-music me-2"></i>{{ user_genre }}
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="/profile" class="btn btn-light btn-sm px-3 py-2">
                        <i class="fas fa-user-edit me-1"></i> Edit Profile
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Emotion Detection -->
    <div class="card mb-4">
        <div class="card-header">
            <h4 class="mb-0"><i class="fas fa-smile me-2"></i>Real-Time Emotion Detection</h4>
        </div>
        <div class="card-body text-center p-4">
            <div class="video-container mx-auto mb-4">
                <img src="{{ url_for('video_feed') }}" class="img-fluid w-500">
            </div>
            <div class="mood-display text-center">
    <div class="mood-title">YOUR CURRENT MOOD</div>
    <div class="mood-underline"></div>
    <div id="current-mood">
        {% if emotion %}
            {{ emotion }}
        {% else %}
            Detecting...
        {% endif %}
    </div>
</div>
        </div>
    </div>

    <!-- Recommendation Form -->
    <div class="card">
        <div class="card-header">
            <h4 class="mb-0"><i class="fas fa-music me-2"></i>Music Recommendations</h4>
        </div>
        <div class="card-body p-4">
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-language me-2"></i>Language</label>
                    <input type="text" class="form-control" id="lang" value="{{ user_language }}">
                </div>
                <div class="col-md-6">
                    <label class="form-label"><i class="fas fa-user me-2"></i>Artist (Optional)</label>
                    <input type="text" class="form-control" id="singer">
                </div>
                <div class="col-12 mt-3">
                    <button onclick="recommendSongs()" class="btn btn-primary w-100 py-3">
                        <i class="fas fa-headphones me-2"></i> Get Perfect Recommendations
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Live Emotion + Song Trigger -->
<script>
    function updateEmotion() {
    fetch('/get_emotion')
    .then(response => response.json())
    .then(data => {
        const moodElement = document.getElementById("current-mood");
        moodElement.innerText = data.emotion || "Detecting...";
        
        // Add emotion-specific color coding
        if(data.emotion) {
            moodElement.style.backgroundImage = getEmotionGradient(data.emotion);
        }
    });
}
function getEmotionGradient(emotion) {
    const gradients = {
        happy: "linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%)",
        sad: "linear-gradient(135deg, #a6c1ee 0%, #fbc2eb 100%)",
        angry: "linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)",
        surprised: "linear-gradient(135deg, #a1c4fd 0%, #c2e9fb 100%)",
        default: "linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%)"
    };
    
    return gradients[emotion.toLowerCase()] || gradients.default;
}

// Update more frequently (every 1 second)
setInterval(updateEmotion, 1000);

    function recommendSongs() {
        let emotion = document.getElementById("current-mood").innerText;
        let lang = document.getElementById("lang").value;
        let singer = document.getElementById("singer").value;

        if (!emotion || emotion === "Unknown") {
            alert("ðŸ˜• Please let me capture your emotion first!");
            return;
        }

        let url = `/recommend_music/${lang}/${singer}`;
        fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                window.open(data.url, "_blank");
            } else {
                alert("Emotion not detected yet!");
            }
        });
    }

    setInterval(updateEmotion, 2000);
</script>
{% endblock %}
